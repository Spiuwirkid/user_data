#!/bin/bash
apt-get update -y
apt-get install -y nginx git curl unzip

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

nvm install 22
nvm use 22

npm install -g pm2

mkdir -p /home/ubuntu/app
git clone https://github.com/Spiuwirkid/ExpressJS-APP.git /home/ubuntu/app/ExpressJS-APP
cd /home/ubuntu/app/ExpressJS-APP

npm install

chown -R ubuntu:ubuntu /home/ubuntu/app/ExpressJS-APP

pm2 start app.js --name "lks-jabar-app"
pm2 save
pm2 startup systemd -u ubuntu --hp /home/ubuntu

cat <<'EOF' > /etc/nginx/sites-available/LKS-JABAR
server {
    listen 80;
    listen [::]:80;

    server_name _;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

ln -s /etc/nginx/sites-available/LKS-JABAR /etc/nginx/sites-enabled/LKS-JABAR
rm -f /etc/nginx/sites-enabled/default # Gunakan -f untuk menghindari error jika file tidak ada

# Uji konfigurasi Nginx dan reload/restart
nginx -t && systemctl reload nginx
systemctl restart nginx # Restart juga tidak masalah, memastikan semua bersih
