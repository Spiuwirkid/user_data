#!/bin/bash
apt-get update -y
apt-get install -y nginx git curl unzip

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
. "$HOME/.nvm/nvm.sh"
nvm install 22
nvm use 22

npm install -g pm2

mkdir -p /home/ubuntu/app
cd /home/ubuntu/app

curl -o lks-app.zip

# Extract app
unzip lks-app.zip
npm install

pm2 start app.js
pm2 save
pm2 startup systemd -u ubuntu --hp /home/ubuntu
pm2 save

cat <<'EOF' > /etc/nginx/sites-available/LKS-JABAR
server {
    listen 80;
    listen [::]:80;

    server_name _;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

ln -s /etc/nginx/sites-available/LKS-JABAR /etc/nginx/sites-enabled/LKS-JABAR

rm /etc/nginx/sites-enabled/default

nginx -t && systemctl reload nginx
