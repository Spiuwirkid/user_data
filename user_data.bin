#!/bin/bash
apt-get update -y
apt-get install -y nginx git curl unzip

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
\. "$HOME/.nvm/nvm.sh"
nvm install 22
nvm use 22

# Install PM2 globally
npm install -g pm2

# Setup app folder
mkdir -p /home/ubuntu/app
cd /home/ubuntu/app

# Download app ZIP from link â†’ GANTI LINK INI SESUAI LKS PAS LOMBA
curl -o lks-app.zip https://your-bucket-or-your-server.com/path-to/lks-app.zip

# Extract app
unzip lks-app.zip
npm install

# Start app with PM2
pm2 start app.js
pm2 save

# Setup PM2 startup (auto start on reboot)
pm2 startup systemd -u ubuntu --hp /home/ubuntu
pm2 save

# Configure Nginx reverse proxy
cat <<'EOF' > /etc/nginx/sites-available/default
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Test Nginx config and restart
nginx -t && systemctl restart nginx
