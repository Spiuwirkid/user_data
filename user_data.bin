#!/bin/bash

# Pastikan script berhenti jika ada perintah yang gagal
set -e

# Update paket dan instal dependensi dasar
apt-get update -y
apt-get install -y nginx git curl unzip

# --- Instal Node.js dan NPM via NodeSource (lebih robust untuk User Data) ---
# Tambahkan repository NodeSource
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -

# Instal Node.js
apt-get install -y nodejs

# Instal PM2 secara global
npm install -g pm2

# --- Persiapan Direktori Aplikasi dan Kloning Repo ---
# Pastikan direktori dimiliki oleh user 'ubuntu' dari awal
mkdir -p /home/ubuntu/app
chown ubuntu:ubuntu /home/ubuntu/app
chmod 755 /home/ubuntu/app # Pastikan izin yang sesuai

# Kloning repo sebagai user 'ubuntu' (lebih aman dan benar hak aksesnya)
# Pastikan user 'ubuntu' bisa mengakses git dan npm
sudo -u ubuntu git clone https://github.com/Spiuwirkid/ExpressJS-APP.git /home/ubuntu/app/ExpressJS-APP

# Masuk ke direktori aplikasi
cd /home/ubuntu/app/ExpressJS-APP

# Instal dependensi Node.js sebagai user 'ubuntu'
sudo -u ubuntu npm install

# --- Konfigurasi PM2 ---
# Jalankan aplikasi dengan PM2 sebagai user 'ubuntu'
# Beri nama aplikasi agar mudah diidentifikasi
sudo -u ubuntu pm2 start app.js --name "lks-jabar-app"
sudo -u ubuntu pm2 save

# Siapkan PM2 startup otomatis sebagai user 'ubuntu'
# Ini akan membuat unit systemd yang memastikan PM2 dan aplikasinya berjalan saat boot
pm2 startup systemd -u ubuntu --hp /home/ubuntu # Ini akan dijalankan oleh root, tapi akan set PM2 di user ubuntu

# --- Konfigurasi Nginx ---
cat <<'EOF' > /etc/nginx/sites-available/LKS-JABAR
server {
    listen 80;
    listen [::]:80;

    server_name _; # Ganti dengan nama domain Anda, misal: example.com www.example.com

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Aktifkan konfigurasi Nginx baru dan hapus default
ln -s /etc/nginx/sites-available/LKS-JABAR /etc/nginx/sites-enabled/LKS-JABAR
rm -f /etc/nginx/sites-enabled/default

# Uji konfigurasi Nginx dan muat ulang/restart layanan
nginx -t && systemctl reload nginx
systemctl restart nginx

echo "Server setup complete!"
